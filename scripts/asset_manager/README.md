# RSR Asset Manager

## Purpose
RSR Asset Manager is an effort to optimise organisation and efficiency of the Cascading Style Sheets (CSS) and Javascript (JS) use in Akvo RSR. 

## Principles

### Organisation
It is very easy to become unorganised with CSS & JS files. This is particular true for CSS. To keep organised while the project is progressing it’s a good strategy to split CSS classes into separate smaller files. Where one file covers one logical area of the site. It might be a specific page or something like "typography". This makes it much easier to understand where the styles are used and how to update the styles in the future. The separated files are then part of a larger asset bundle, but more on that later.

### Efficiency
Besides keeping ourself organised we also want to handle external assets such as CSS and JS files as efficient as possible to keep users page load time down to a minimum. There are three ways that are front end related that the asset manager addresses: number of HTTP requests, use of browser cache and file size.

#### Minimise the number of HTTP requests
To minimise the number of HTTP requests is a crucial step for first time visitor's page load time. The reason is that every HTTP request have a overhead cost(time). Hence we don’t want to serve several CSS & JS files (Asset files). We will need to combine each bundle's files into one bundle file and serve that combined file to the browser.

#### Make use of the users browser cache
We want the user's browser to cache files as aggressive as possible. This is enabled by setting far future expires headers (server setting, see link in resources) on asset files. This will make the browser grab available files from the local browser cache instead of downloading them over the Internet repeatedly. At the same time we need a way to make sure that new asset files are downloaded from our server e.i. invalidate old browser cache. This issue is solved by renaming the asset file based on it’s contents with a fingerprint. If the bundle file is update on our server it will get a new name and by doing so the previous browser cache will be side stepped.

#### Keep the asset files small for faster download
To optimise the page speed we want to keep the asset files as small as possible. Because of this we will minimise the asset files with the help of the YUICompressor. This tool have been reported to shrink file sizes with ~20%.

#### Minimise manual labour
Since we don’t want to do anything manual that can be done automatically we will use Git to regenerate the asset files on commit. Since git have a pre-commit hook we will use that to make sure the asset files always are up to date.

## Implementation details

### Overview
We will use a Python dictionary to define asset bundles. You will load a asset bundle where you used to load a css or a javascript file in the templates. A asset bundle can consist of one or several CSS or JS files. The asset bundles will then be loaded in the template with the help of a Django template tag named "asset_bundle". A Git hook is used to automatically repack the asset bundles on every new commit. 

### Asset Manager elements
- akvo/scripts/asset_manager/asset_bundle.py, file where asset_bundles are defined by the develper.   
- akvo/scripts/asset_manager/map.py, file used by Django for template tags lookups (populated by packer.py).   
- akvo/scripts/asset_manager/packer.py, generates combined & compressed bundle files.  
- {% asset_bundle ‘foo’ %}, Django template tag loading the 'foo' bundle (uses the map.py for lookup).   
- git_hooks/pre-commit, Hook that call the packer script before a commit.   
- akvo/scripts/asset_manager/__init__.py, On first request and execution a symlink to the git hook is made.    (hence one need to run the project to setup the githook!!!)   
- A DEV_ASSET_BUNDLES=TRUE setting.   
- Expires header to the web server configuration. (optional)   

### In depth / example
On commit the git hook kickstarts the packer script which parses the asset_bundle.py files for asset_bundles. When it finds a bundle, e.g. ‘akvo_styles’, it reads the bundle settings and starts to combine the bundle files (e.g. ‘typography” or ”footer”) into one bundle file. When this is done the bundle file is compressed with YUICompressor. The combined and compressed file is then named with a fingerprint (hash) based on it’s contents. The hash is added to the map.py file for Django template tag lookup. In the template we would then add the template tag {% asset_bundle ‘akvo_styles’ %} to load the latest fingerprinted bundle file.

### Development mode
The development mode (to side step the git commit packaging) is utilised by adding a ASSET_MANAGER_DEV=TRUE to the settings file. For styles the template tag will link against a raw file which are generated by the packer script. The raw file then imports the source files by using css @imports. For javascript the template tag will link directly to the source files.

## Things to consider

### Conventions
One can name the source files to whatever but it's recommended to use a prefix such as "x_" e.g. x_style_name.css. This way it will be clear what's source files defined by the developer and what is automatic generated files by the asset manager.

### Aborted commits
If the script stumbles upon errors because of a misconfiguration of the asset_bundles the commit will be aborted. This is done by design. We don't want to checkin broken code. And only changes to the asset bundles will be a possibility for those errors.

### Git hook setup
The pre-commit git hook is setup on the first http request. Hence if you clone the system the git-hook will not be in place before you have run the project. If you want you can always manually symlink the pre-commit hook from ".git/hooks/" to "git_hooks/" in the project root. The automatic sym-linking is made in "akvo/scripts/asset_manager/__init__.py". 

### New source files
If you want to add a new source file to a bundle the actual asset_bundle definition needs to commit before it's used for combining. Hence you need an extra commit of adding the source file to asset_bundles and then before the second commit the pre-commit hook is triggered and that will generate a new combined file and include that in the new commit.

## Resources:
http://developer.yahoo.com/performance/rules.html   
http://developer.yahoo.com/yui/compressor/   
http://cjohansen.no/en/apache/using_a_far_future_expires_header   

## Roadmap:
Would be nice to have validation of css & javascript(maybe even JSLint) as a requirement.

At the moment all asset are repacked on every commit. One could implement some smartness by using git and only repack when there is changes but since the packing is not that time consuming it's probably better to keep it as is.

The git hook is setup on execution of the akvo/scripts/asset_manager/__init__.py, The hook should probably be set with the deployment script